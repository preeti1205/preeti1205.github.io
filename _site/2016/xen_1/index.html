<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Installing Xen hypervisor & Virtual Machine on Ubuntu</title>
  <meta name="description" content="Taking on the world, one algorithm at a time">
  <meta name="author" content="Preeti Bhandari">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Preeti Bhandari">
  <meta name="twitter:description" content="Taking on the world, one algorithm at a time">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Preeti Bhandari">
  <meta property="og:description" content="Taking on the world, one algorithm at a time">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="//2016/xen_1/">
  <link rel="alternate" type="application/rss+xml" title="Preeti Bhandari" href="/feed.xml">

</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Preeti Bhandari">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Preeti Bhandari</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Taking on the world, one algorithm at a time</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Preeti Bhandari blog" class="blog-button">Blog</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

              

              
                <!-- Projects -->
                <li class="navigation__item">
                  <a href="http://preetibhandari.com/projects" title="Projects" target="_blank">
                    <i class="icon icon-lightbulb"></i>
                    <span class="label">Projects</span>
                  </a>
                </li>
              

              
                <!-- Goodreads -->
                <li class="navigation__item">
                  <a href="http://goodreads.com/preeti1205" title="@preeti1205 on Goodreads" target="_blank">
                    <i class="icon icon-book"></i>
                    <span class="label">Goodreads</span>
                  </a>
                </li>
              

              
                <!-- Leetcode -->
                <li class="navigation__item">
                  <a href="http://leetcode.com/pb1771" title="@pb1771 on LeetCode" target="_blank">
                    <i class="icon icon-italic"></i>
                    <span class="label">LeetCode</span>
                  </a>
                </li>
              

              
                <!-- HackerRank -->
                <li class="navigation__item">
                  <a href="http://hackerrank.com/preeti_bhandari" title="@preeti_bhandari on HackerRank" target="_blank">
                    <i class="icon icon-laptop"></i>
                    <span class="label">Hackerrank</span>
                  </a>
                </li>
              

            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/preeti-bhandari-036470104" title="preeti-bhandari-036470104 on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/preeti1205" title="preeti1205 on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            
              <!-- Email -->
              <li class="navigation__item">
                <a href="mailto:preeti.bhandari@nyu.edu" title="Email preeti.bhandari@nyu.edu" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>
            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="30 Nov 2016" class="post-meta__date date">30 Nov 2016</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#virtualization">virtualization</a> </span>
    </div>
    <h1 class="post-title">Installing Xen hypervisor & Virtual Machine on Ubuntu</h1>
  </header>

  <section class="post">
    <p>Dom0 -&gt; Ubuntu 14.04.5 - Trusty Tahr LTS</p>

<p>DomU -&gt; Ubuntu 14.04.4 - Trusty Tahr</p>

<h4 id="installing-dom0">Installing Dom0</h4>

<p>During the Dom0 installation, use ‘Install using LVM(Logical Volume Management)’ option for Ubuntu 14.04. The disk space will be assigned by default. We can resize the partitions using LVM later. For the time being, accept the default sizes and finish the installation of Dom0. The size of Dom0 is ideally between 5 to 10GB.</p>

<h4 id="installing-xen-hypervisor">Installing Xen hypervisor</h4>

<p>Install the 64-bit hypervisor. It also works with 32-bit dom0 kernel while allowing you to install 64-bit guests</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install xen-hypervisor-amd64
</code></pre></div></div>

<p>Reboot the system</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo reboot
</code></pre></div></div>

<p>To verify if the installation has succeeded, use the command</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xl list
</code></pre></div></div>

<p>The Domain-0 information will appear for a successful installation. Also, the system will boot Xen if installation is successful. For distributions before 14.04, you will have to make changes to GRUB for it to boot Xen as default.</p>

<h4 id="network-configuration">Network Configuration</h4>

<p>The following configuration steps are for a wired interface. We will use the bridged network configuration.</p>

<ol>
  <li>Disable the Network Manager
  We are going to manually configure the network settings and hence we disable the network manager which might be automatically configuring the network settings for us.
  This step will cause temporary loss of internet connection and hence one has to be physically connected to the machine</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo stop network-manager
echo "manual" | sudo tee /etc/init/network-manager.override
</code></pre></div></div>

<ol>
  <li>Use bridge-utils</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sudo apt-get install bridge-utils
</code></pre></div></div>

<p>For a bridged setup, we are required to assign ip address to the bridged interface. Make the necessary changes to /etc/network/interfaces file to get the ip either through dhcp or my using static ip. For our case, we are going to assign a static ip address 192.168.1.1</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/network/interfaces
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  auto lo eth0 xenbr0
  iface lo inet loopback

  iface eth0 inet manual

  allow-hotplug xenbr0
  iface xenbr0 inet static
    address 192.168.1.111
    netmask 255.255.255.0
    gateway 192.168.1.1
    bridge-ports eth0
</code></pre></div></div>

<p>The above configuration will create a linux bridge named xenbr0 which will be connected to interface eth0. eth0 will have the assigned ip address.</p>

<p>NOTE: Make sure that you are in fact connected to the router using eth0 (or the interface you have in your file) in case you have multiple ethernet ports.</p>

<h4 id="setting-up-ssh-on-the-server">Setting up SSH on the server</h4>
<p>Use apt-get to install SSH server.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install openssh-server
</code></pre></div></div>

<p>Now restart the ssh server using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /etc/init.d/ssh restart
</code></pre></div></div>

<p>In case you don’t have a ssh key on your system, use the following command to generate one:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -t rsa -C "name@server_ip"
</code></pre></div></div>

<p>Following the instructions or keep pressing enter to save the key to the default settings.</p>

<p>To reconnect to a system you have previously been connected to and which now has a new identification, use</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -R name@server_ip
</code></pre></div></div>

<p>This will delete the old hash associated with the server ip address and create a new one.</p>

<h4 id="resizing-the-root-logical-volume">Resizing the root logical volume</h4>
<p>When you use the LVS option during installation, two partitions are created: root and swap_1. To see how much physical memory is allocated to each partition, type</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo lvs
</code></pre></div></div>

<p>You will notice there is nearly no free space available in these two logical volumes. So, you will have to free up space to create new logical volumes. Reducing the size of swap_1 can be done in a single line. We do it before installing the VMs to avoid any data loss that might occur to VMs or files residing in this logical volume in case they are installed before resizing.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo lvresize -L -120G ubuntu-vg/swap_1
</code></pre></div></div>

<p>This will reduce the size of swap_1 by 120 GB. In case you want to expand the logical volume(lv), drop the - sign.</p>

<p>The tricky part however is shrinking the root lv. Since, it is where your file system is residing, it is bad idea to use lvresize directly on it. We need to shrink the filesystem before we can safely shrink the logical volume.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vgchange -a y
sudo e2fsck -f /dev/ubuntu-vg/root
sudo resize2fs /dev/ubuntu-vg/root 40G         //reduce file sytem to 90% of your desired lv size
sudo lvreduce -L 50G /dev/ubuntu-vg/root      //the root lv is resized to 50G
</code></pre></div></div>

<p>Check if everything is working fine by rebooting the system.</p>

<h4 id="creating-virtual-machines">Creating Virtual Machines</h4>
<p>For this part we will need physical and logical volume. As the name suggests, physical volume is a partition on the hard disk or hard disk itself. Volume group is a aggregation of physical volumes combined to form one large “virtual physical” volume. Logical volumes are the “pseudo/virtual/logical” partition residing in volume group.Read more about it <a href="https://wiki.archlinux.org/index.php/LVM">here</a></p>

<p>As we have already partitioned the disk using LVM, it has already created a volume group for us. To list the volume groups, use the following command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vgs
</code></pre></div></div>

<p>For each of the virtual machine installations, we are going to create one logical volume.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo lvcreate -L 10G -n vm-1 /dev/&lt;volume-group&gt;
</code></pre></div></div>

<p>This will create a logical volume named vm-1 of size 10GB living in volume group name you specify.</p>

<p>To list the logical volumes, use</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo lvs
</code></pre></div></div>

<h4 id="installing-a-hvm-guest-vm">Installing a HVM guest VM</h4>

<p>Download the guest operating system using wget. I am using Ubuntu 14.04 as the guest OS.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo wget http://releases/ubuntu.com/14.04/ubuntu-14.04.4-desktop.amd64.iso
</code></pre></div></div>

<p>Create a guest config file /etc/xen/vm-1.cfg</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>builder = "hvm"
name = "vm-1"
memory = "2048"
vcpus = 2
vif = ['']
disk = ['phy:/dev/&lt;VG&gt;/vm-1,hda,w','file:/root/ubuntu-14.04.4-desktop-amd64.iso,hdc:cdrom,r']
vnc = 1
boot="dc"
</code></pre></div></div>

<p>The vnc option specifies if the file should use vnc. For vnc=1, an external vncviewer is connected. The server will listen on ADDR (default 127.0.0.1) on port N+5900. N defaults to the domain id. If vncunused=1, the server will try to find an arbitrary unused port above 5900.</p>

<p>Create the virtual machine using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xl create /etc/xen/vm-1.cfg
</code></pre></div></div>

<p>To view the VM, you can use either vncviewer or xtightvncviewer. xtightvncviewer is a lot faster. You will have to install vncviewer/xtightvncviewer using apt-get.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install vncviewer
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vncviewer localhost:0
</code></pre></div></div>
<p>or</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xtightvncviewer localhost:0
</code></pre></div></div>

<p>You might have to install some java dependencies on the server to use vnc. Also, if the port 0 does not work, try using a different port number.</p>

<p>We have not set any password for vnc in the config file, so click enter when prompted for passcode.</p>

<p>Install the VM you would install on your system. You can either use an LVM o non LVM method for disk partition. Once, the OS has been installed, when prompted to reboot, hit enter. You will notice that the system fails to shut down. This kind of behaviour is expected.</p>

<p>Shut down the vnc window. Go to the terminal of your server, and destroy the VM</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xl destroy vm-1
</code></pre></div></div>

<p>Now go back to your VM config file /etc/xen/vm-1.cfg and commented out and add lines as shown below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>builder = "hvm"
name = "vm-1"
memory = "1024"
vcpus = 2
vif = ['']
#disk = ['phy:/dev/&lt;VG&gt;/vm-1,hda,w','file:/root/ubuntu-14.04.4-desktop-amd64.iso,hdc:cdrom,r']
disk = ['phy:/dev/&lt;VG&gt;/vm-1,hda,w']
vnc = 1
boot="c"
#boot="dc"
</code></pre></div></div>

<p>Now start the VM again and your VM is ready.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo xl create /etc/xen/vm-1.cfg
</code></pre></div></div>

  </section>
  
</article>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2020 Preeti Bhandari. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

    </div>
  </body>
</html>